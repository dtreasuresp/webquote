generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DATABASE_URL_UNPOOLED")
}

model QuotationConfig {
  id                            String                @id @default(cuid())
  numero                        String                @unique @default("")
  fechaEmision                  DateTime              @default(now())
  tiempoValidez                 Int                   @default(30)
  fechaVencimiento              DateTime
  presupuesto                   String                @default("")
  moneda                        String                @default("USD")
  empresa                       String                @default("")
  sector                        String                @default("")
  ubicacion                     String                @default("")
  profesional                   String                @default("")
  empresaProveedor              String                @default("")
  ubicacionProveedor            String                @default("")
  createdAt                     DateTime              @default(now())
  updatedAt                     DateTime              @updatedAt
  heroTituloMain                String                @default("PROPUESTA DE COTIZACIÓN")
  heroTituloSub                 String                @default("SERVICIO A PRESTAR")
  tiempoVigenciaUnidad          String                @default("meses")
  tiempoVigenciaValor           Int                   @default(12)
  emailCliente                  String                @default("")
  whatsappCliente               String                @default("")
  activo                        Boolean               @default(true)
  emailProveedor                String                @default("")
  isGlobal                      Boolean               @default(false)
  versionNumber                 Int                   @default(1)
  whatsappProveedor             String                @default("")
  configDescuentosTemplate      Json?
  estilosConfig                 Json?
  metodoPagoPreferido           String?               @default("")
  notasPago                     String?               @default("")
  opcionesPagoTemplate          Json?
  serviciosBaseTemplate         Json?
  serviciosOpcionalesTemplate   Json?
  contenidoGeneral              Json?
  editorState                   Json?
  descripcionesPaqueteTemplates Json?
  metodosPreferidos             Json?
  packagesSnapshot              Json?
  packagesSnapshotAt            DateTime?
  organizationId                String?
  estado                        QuotationState        @default(CARGADA)
  activadoEn                    DateTime?
  inactivadoEn                  DateTime?
  respondidoEn                  DateTime?
  diasParaAceptar               Int?
  expiradoEn                    DateTime?
  accountId                     String?
  contactId                     String?
  opportunityId                 String?
  subtotal                      Decimal?              @db.Decimal(12, 2)
  taxRate                       Decimal?              @db.Decimal(5, 2) @default(0)
  taxTotal                      Decimal?              @db.Decimal(12, 2)
  discountTotal                 Decimal?              @db.Decimal(12, 2)
  total                         Decimal?              @db.Decimal(12, 2)
  approvalStatus                ApprovalStatus        @default(DRAFT)
  approvalNotes                 String?
  approvedBy                    String?
  approvedAt                    DateTime?
  templateId                    String?
  clientResponses               ClientResponse[]
  snapshots                     PackageSnapshot[]
  approvalFlows                 ApprovalFlow[]
  account                       Account?              @relation(fields: [accountId], references: [id])
  contact                       Contact?              @relation(fields: [contactId], references: [id])
  opportunity                   Opportunity?          @relation(fields: [opportunityId], references: [id])
  organization                  Organization?         @relation(fields: [organizationId], references: [id])
  documentTemplate              DocumentTemplate?     @relation(fields: [templateId], references: [id])
  lineItems                     QuoteLineItem[]
  User                          User?
  UserQuotationAccess           UserQuotationAccess[]

  @@index([createdAt])
  @@index([isGlobal])
  @@index([activo])
  @@index([estado])
  @@index([respondidoEn])
  @@index([expiradoEn])
  @@index([organizationId])
  @@index([accountId])
  @@index([contactId])
  @@index([opportunityId])
  @@index([templateId])
}

model PackageSnapshot {
  id                    String           @id @default(cuid())
  nombre                String
  serviciosBase         Json
  desarrollo            Float
  descuento             Int
  tipo                  String?
  descripcion           String?
  emoji                 String?
  tagline               String?
  tiempoEntrega         String?
  opcionesPago          Json?
  descuentoPagoUnico    Int?
  otrosServicios        Json
  costoInicial          Float
  costoAño1            Float
  costoAño2            Float
  activo                Boolean          @default(true)
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt
  quotationConfigId     String?
  descuentosGenerales   Json?
  descuentosPorServicio Json?
  configDescuentos      Json?
  metodoPagoPreferido   String?          @default("")
  notasPago             String?
  subtituloSeccionPago  String?
  tituloSeccionPago     String?          @default("Opciones de Pago")
  metodosPreferidos     Json?
  quotationConfig       QuotationConfig? @relation(fields: [quotationConfigId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([quotationConfigId])
}

model UserPreferences {
  id                             String   @id @default(cuid())
  userId                         String   @unique
  cerrarModalAlGuardar           Boolean  @default(false)
  mostrarConfirmacionGuardado    Boolean  @default(true)
  validarDatosAntes              Boolean  @default(true)
  createdAt                      DateTime @default(now())
  updatedAt                      DateTime @updatedAt
  limpiarFormulariosAlCrear      Boolean  @default(true)
  destinoGuardado                String   @default("ambos")
  intervaloVerificacionConexion  Int      @default(30)
  mantenerDatosAlCrearCotizacion Boolean  @default(false)
  mostrarNotificacionCacheLocal  Boolean  @default(true)
  sincronizarAlRecuperarConexion Boolean  @default(true)
  unidadIntervaloConexion        String   @default("segundos")
  auditAutoPurgeEnabled          Boolean  @default(false)
  auditAutoPurgeFrequency        String   @default("weekly")
  auditAutoReportEnabled         Boolean  @default(false)
  auditAutoReportPeriod          String   @default("weekly")
  auditRetentionDays             Int      @default(90)
  guardarAutomaticamente         Boolean  @default(true)
  auditAutoReportHour            Int      @default(1)
  auditAutoReportMinute          Int      @default(0)
  autoBackupEnabled              Boolean  @default(false)
  autoBackupHour                 Int      @default(2)
  autoBackupMinute               Int      @default(0)
  autoBackupPeriod               String   @default("weekly")
  autoBackupRetentionDays        Int      @default(30)
  auditReportRetentionDays       Int      @default(90)
  notifyOnAutoReport             Boolean  @default(true)
  notifyOnManualReport           Boolean  @default(true)

  @@index([userId])
}

model FinancialTemplate {
  id                   String   @id
  userId               String
  nombre               String
  desarrollo           Float    @default(0)
  descuento            Int      @default(0)
  opcionesPago         Json?
  tituloSeccionPago    String?  @default("Opciones de Pago")
  subtituloSeccionPago String?
  metodosPreferidos    Json?
  notasPago            String?
  configDescuentos     Json?
  descuentoPagoUnico   Int?     @default(0)
  createdAt            DateTime @default(now())
  updatedAt            DateTime

  @@index([userId])
}

model Organization {
  id          String            @id @default(cuid())
  nombre      String
  legalName   String?
  taxId       String?
  sector      String
  industry    String?
  website     String?
  descripcion String?
  email       String?
  telefono    String?
  size        String?
  revenue     String?
  parentId    String?
  nivel       String            @default("RAIZ")
  activo      Boolean           @default(true)
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  createdBy   String
  updatedBy   String
  direccion   String?
  ciudad      String?
  pais        String?
  parent      Organization?     @relation("OrganizationHierarchy", fields: [parentId], references: [id])
  children    Organization[]    @relation("OrganizationHierarchy")
  quotations  QuotationConfig[]
  users       User[]

  @@index([parentId])
  @@index([createdBy])
}

model Permission {
  id              String            @id @default(cuid())
  code            String            @unique
  name            String
  description     String?
  category        String
  isActive        Boolean           @default(true)
  createdAt       DateTime          @default(now())
  isSystem        Boolean           @default(false)
  RolePermissions RolePermissions[]
  UserPermission  UserPermission[]

  @@index([category])
  @@index([code])
  @@index([isActive])
}

model Role {
  id          String            @id @default(cuid())
  name        String            @unique
  displayName String
  description String?
  hierarchy   Int               @default(50)
  color       String?
  isSystem    Boolean           @default(false)
  isActive    Boolean           @default(true)
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  permissions RolePermissions[]
  users       User[]            @relation("UserRole")

  @@index([hierarchy])
  @@index([isActive])
}

model RolePermissions {
  id           String     @id @default(cuid())
  roleId       String
  permissionId String
  accessLevel  String     @default("full")
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
}

model Session {
  id           String   @id
  sessionToken String   @unique
  userId       String
  expires      DateTime
  User         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([sessionToken])
  @@index([userId])
}

model User {
  id                  String                @id @default(cuid())
  username            String                @unique
  email               String?               @unique
  passwordHash        String
  role                UserRole              @default(CLIENT)
  nombre              String                @default("")
  empresa             String                @default("")
  telefono            String                @default("")
  quotationAssignedId String?               @unique
  activo              Boolean               @default(true)
  lastLogin           DateTime?
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  createdBy           String?
  avatarUrl           String?
  roleId              String?
  organizationId      String?
  AuditLog            AuditLog[]
  AuditReports        AuditReport[]
  BackupConfig        BackupConfig?
  Notification        Notification[]
  Session             Session[]
  organization        Organization?         @relation(fields: [organizationId], references: [id])
  quotationAssigned   QuotationConfig?      @relation(fields: [quotationAssignedId], references: [id])
  roleRef             Role?                 @relation("UserRole", fields: [roleId], references: [id])
  UserBackup          UserBackup[]
  UserPermission      UserPermission[]
  UserQuotationAccess UserQuotationAccess[]

  @@index([activo])
  @@index([email])
  @@index([quotationAssignedId])
  @@index([organizationId])
  @@index([role])
  @@index([roleId])
  @@index([username])
}

model UserPermission {
  id           String     @id
  userId       String
  permissionId String
  granted      Boolean
  Permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  User         User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, permissionId])
  @@index([permissionId])
  @@index([userId])
}

model UserQuotationAccess {
  id                String          @id
  userId            String
  quotationConfigId String
  canEdit           Boolean         @default(true)
  canDelete         Boolean         @default(false)
  assignedAt        DateTime        @default(now())
  assignedBy        String?
  isDefault         Boolean         @default(false)
  QuotationConfig   QuotationConfig @relation(fields: [quotationConfigId], references: [id], onDelete: Cascade)
  User              User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, quotationConfigId])
  @@index([quotationConfigId])
  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model AuditLog {
  id         String   @id @default(cuid())
  action     String
  entityType String
  entityId   String?
  userId     String?
  userName   String
  details    Json?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())
  user       User?    @relation(fields: [userId], references: [id])

  @@index([action])
  @@index([entityType])
  @@index([userId])
  @@index([createdAt])
}

model UserBackup {
  id           String    @id @default(cuid())
  userId       String
  nombre       String
  descripcion  String?
  tipo         String    @default("manual")
  version      String?
  data         Json
  size         Int?
  estado       String    @default("completado")
  errorMessage String?
  createdAt    DateTime  @default(now())
  expiresAt    DateTime?
  User         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
  @@index([tipo])
}

model BackupConfig {
  id                  String    @id @default(cuid())
  userId              String    @unique
  autoBackupEnabled   Boolean   @default(false)
  autoBackupFrequency String    @default("weekly")
  autoBackupRetention Int       @default(5)
  notifyOnBackup      Boolean   @default(true)
  notifyOnRestore     Boolean   @default(true)
  lastAutoBackup      DateTime?
  nextAutoBackup      DateTime?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  User                User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model AuditReport {
  id             String   @id @default(cuid())
  userId         String
  period         String   @default("weekly")
  dateRangeFrom  DateTime
  dateRangeTo    DateTime
  totalLogs      Int
  uniqueUsers    Int
  uniqueActions  Int
  uniqueEntities Int
  reportData     Json
  generatedAt    DateTime @default(now())
  generatedBy    String   @default("system")
  filePath       String?
  status         String   @default("completed")
  errorMessage   String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([period])
  @@index([generatedAt])
  @@index([createdAt])
}

model ClientResponse {
  id                String          @id @default(cuid())
  quotationConfigId String
  clientUserId      String?
  clientName        String
  clientEmail       String
  responseType      String
  mensaje           String?
  respondidoEn      DateTime        @default(now())
  diasRestantes     Int?
  ipAddress         String?
  userAgent         String?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  quotationConfig   QuotationConfig @relation(fields: [quotationConfigId], references: [id], onDelete: Cascade)
  notificaciones    Notification[]

  @@index([quotationConfigId])
  @@index([clientUserId])
  @@index([responseType])
  @@index([respondidoEn])
}

model Notification {
  id               String          @id @default(cuid())
  userId           String
  clientResponseId String?
  titulo           String
  descripcion      String?
  tipoNotificacion String
  leida            Boolean         @default(false)
  leidoEn          DateTime?
  createdAt        DateTime        @default(now())
  clientResponse   ClientResponse? @relation(fields: [clientResponseId], references: [id])
  user             User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([leida])
  @@index([createdAt])
}

model Account {
  id              String            @id @default(cuid())
  legalName       String
  commercialName  String?
  taxId           String?           @unique
  type            AccountType       @default(EMPRESA)
  status          AccountStatus     @default(PROSPECT)
  email           String?
  phone           String?
  website         String?
  address         String?
  city            String?
  state           String?
  zipCode         String?
  country         String?
  sector          String?
  size            String?
  creditLimit     Decimal?          @db.Decimal(12, 2)
  paymentTerms    String?
  viesVerified    Boolean           @default(false)
  complianceNotes String?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  createdBy       String?
  contacts        Contact[]
  interactions    Interaction[]
  opportunities   Opportunity[]
  quotations      QuotationConfig[]
  subscriptions   Subscription[]
  compliance      ComplianceRecord[]

  @@index([legalName])
  @@index([taxId])
  @@index([status])
}

model Contact {
  id                    String            @id @default(cuid())
  accountId             String
  fullName              String
  title                 String?
  role                  ContactRole       @default(USER)
  email                 String?
  phone                 String?
  mobile                String?
  preferredContact      ContactPreference @default(EMAIL)
  language              String            @default("es")
  timezone              String?
  preferredContactHours String?
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt
  account               Account           @relation(fields: [accountId], references: [id], onDelete: Cascade)
  interactions          Interaction[]
  quotations            QuotationConfig[]

  @@index([accountId])
  @@index([email])
}

model Product {
  id               String           @id @default(cuid())
  name             String
  sku              String           @unique
  type             ProductType      @default(PRODUCT)
  category         String
  description      String?
  listPrice        Decimal          @db.Decimal(12, 2)
  costPrice        Decimal?         @db.Decimal(12, 2)
  available        Boolean          @default(true)
  stock            Int?
  leadTimeDays     Int?
  taxCategory      String?
  appliesTax       Boolean          @default(true)
  billingFrequency BillingFrequency @default(ONE_TIME)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  @@index([sku])
  @@index([category])
}

model Opportunity {
  id                String            @id @default(cuid())
  accountId         String
  name              String
  stage             OpportunityStage  @default(PROSPECT)
  probability       Int               @default(0)
  estimatedValue    Decimal?          @db.Decimal(12, 2)
  expectedCloseDate DateTime?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  account           Account           @relation(fields: [accountId], references: [id], onDelete: Cascade)
  quotations        QuotationConfig[]

  @@index([accountId])
  @@index([stage])
}

model Interaction {
  id          String          @id @default(cuid())
  accountId   String
  contactId   String?
  type        InteractionType @default(NOTE)
  subject     String?
  description String
  messageId   String?
  assignedTo  String?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  account     Account         @relation(fields: [accountId], references: [id], onDelete: Cascade)
  contact     Contact?        @relation(fields: [contactId], references: [id])

  @@index([accountId])
  @@index([contactId])
  @@index([type])
  @@index([createdAt])
}

enum QuotationState {
  CARGADA
  ACTIVA
  INACTIVA
  ACEPTADA
  RECHAZADA
  NUEVA_PROPUESTA
  EXPIRADA
}

enum UserRole {
  ADMIN
  CLIENT
  SUPER_ADMIN
}

enum AccountType {
  EMPRESA
  INDIVIDUAL
  PROSPECT
}

enum AccountStatus {
  PROSPECT
  LEAD
  ACTIVE
  INACTIVE
  ARCHIVED
}

enum ContactRole {
  DECISION_MAKER
  INFLUENCER
  USER
  TECHNICAL
}

enum ContactPreference {
  EMAIL
  PHONE
  WHATSAPP
  SMS
}

enum ProductType {
  PRODUCT
  SERVICE
  LICENSE
  SUBSCRIPTION
}

enum BillingFrequency {
  MONTHLY
  QUARTERLY
  ANNUAL
  ONE_TIME
}

enum OpportunityStage {
  PROSPECT
  QUALIFIED
  PROPOSAL
  NEGOTIATION
  CLOSED_WON
  CLOSED_LOST
}

enum InteractionType {
  EMAIL
  CALL
  MEETING
  NOTE
  DOCUMENT
}

model Subscription {
  id               String           @id @default(cuid())
  accountId        String
  productId        String?
  name             String
  status           String           @default("ACTIVE")
  billingFrequency BillingFrequency @default(MONTHLY)
  amount           Decimal          @db.Decimal(12, 2)
  startDate        DateTime         @default(now())
  endDate          DateTime?
  nextBillingDate  DateTime?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  account          Account          @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([accountId])
  @@index([status])
}

model ComplianceRecord {
  id             String   @id @default(cuid())
  accountId      String
  type           String
  status         String   @default("PENDING")
  documentUrl    String?
  notes          String?
  validUntil     DateTime?
  verifiedAt     DateTime?
  verifiedBy     String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  account        Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([accountId])
  @@index([type])
}

model QuoteLineItem {
  id                String          @id @default(cuid())
  quotationConfigId String
  productId         String?
  description       String
  quantity          Int             @default(1)
  unitPrice         Decimal         @db.Decimal(12, 2)
  discount          Decimal?        @db.Decimal(5, 2)
  tax               Decimal?        @db.Decimal(5, 2)
  total             Decimal         @db.Decimal(12, 2)
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  quotationConfig   QuotationConfig @relation(fields: [quotationConfigId], references: [id], onDelete: Cascade)

  @@index([quotationConfigId])
}

enum ApprovalStatus {
  DRAFT
  PENDING
  APPROVED
  REJECTED
}

model AutomationRule {
  id          String   @id @default(cuid())
  name        String
  description String?
  trigger     String   // e.g., "QUOTE_CREATED", "QUOTE_UPDATED"
  conditions  Json     // e.g., { "total": { "gt": 10000 } }
  actions     Json     // e.g., { "requireApproval": true, "approverRole": "MANAGER" }
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model ApprovalFlow {
  id                String          @id @default(cuid())
  quotationConfigId String
  approverId        String?
  approverRole      String?
  status            ApprovalStatus  @default(PENDING)
  notes             String?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  quotationConfig   QuotationConfig @relation(fields: [quotationConfigId], references: [id], onDelete: Cascade)

  @@index([quotationConfigId])
}

model DocumentTemplate {
  id          String   @id @default(cuid())
  name        String
  type        String   // EMAIL, PDF, CONTRACT
  content     String   @db.Text
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  quotations  QuotationConfig[]
}
