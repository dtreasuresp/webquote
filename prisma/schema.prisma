generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DATABASE_URL_UNPOOLED")
}

model QuotationConfig {
  id                            String                @id @default(cuid())
  numero                        String                @unique @default("")
  fechaEmision                  DateTime              @default(now())
  tiempoValidez                 Int                   @default(30)
  fechaVencimiento              DateTime
  presupuesto                   String                @default("")
  moneda                        String                @default("USD")
  empresa                       String                @default("")
  sector                        String                @default("")
  ubicacion                     String                @default("")
  profesional                   String                @default("")
  empresaProveedor              String                @default("")
  ubicacionProveedor            String                @default("")
  createdAt                     DateTime              @default(now())
  updatedAt                     DateTime              @updatedAt
  heroTituloMain                String                @default("PROPUESTA DE COTIZACIÓN")
  heroTituloSub                 String                @default("PÁGINA CATÁLOGO DINÁMICA")
  tiempoVigenciaUnidad          String                @default("meses")
  tiempoVigenciaValor           Int                   @default(12)
  emailCliente                  String                @default("")
  whatsappCliente               String                @default("")
  activo                        Boolean               @default(true)
  emailProveedor                String                @default("")
  isGlobal                      Boolean               @default(false)
  versionNumber                 Int                   @default(1)
  whatsappProveedor             String                @default("")
  configDescuentosTemplate      Json?
  estilosConfig                 Json?
  metodoPagoPreferido           String?               @default("")
  notasPago                     String?               @default("")
  opcionesPagoTemplate          Json?
  serviciosBaseTemplate         Json?
  serviciosOpcionalesTemplate   Json?
  contenidoGeneral              Json?
  editorState                   Json?
  descripcionesPaqueteTemplates Json?
  metodosPreferidos             Json?
  packagesSnapshot              Json?
  packagesSnapshotAt            DateTime?
  // NUEVO: Relación con Organization
  organizationId                String?
  organization                  Organization?         @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  snapshots                     PackageSnapshot[]
  User                          User?
  UserQuotationAccess           UserQuotationAccess[]

  @@index([createdAt])
  @@index([isGlobal])
  @@index([activo])
  @@index([organizationId])
}

model PackageSnapshot {
  id                    String           @id @default(cuid())
  nombre                String
  serviciosBase         Json
  desarrollo            Float
  descuento             Int
  tipo                  String?
  descripcion           String?
  emoji                 String?
  tagline               String?
  tiempoEntrega         String?
  opcionesPago          Json?
  descuentoPagoUnico    Int?
  otrosServicios        Json
  costoInicial          Float
  costoAño1            Float
  costoAño2            Float
  activo                Boolean          @default(true)
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt
  quotationConfigId     String?
  descuentosGenerales   Json?
  descuentosPorServicio Json?
  configDescuentos      Json?
  metodoPagoPreferido   String?          @default("")
  notasPago             String?
  subtituloSeccionPago  String?
  tituloSeccionPago     String?          @default("Opciones de Pago")
  metodosPreferidos     Json?
  quotationConfig       QuotationConfig? @relation(fields: [quotationConfigId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([quotationConfigId])
}

model UserPreferences {
  id                             String   @id @default(cuid())
  userId                         String   @unique
  cerrarModalAlGuardar           Boolean  @default(false)
  mostrarConfirmacionGuardado    Boolean  @default(true)
  validarDatosAntes              Boolean  @default(true)
  createdAt                      DateTime @default(now())
  updatedAt                      DateTime @updatedAt
  limpiarFormulariosAlCrear      Boolean  @default(true)
  destinoGuardado                String   @default("ambos")
  intervaloVerificacionConexion  Int      @default(30)
  mantenerDatosAlCrearCotizacion Boolean  @default(false)
  mostrarNotificacionCacheLocal  Boolean  @default(true)
  sincronizarAlRecuperarConexion Boolean  @default(true)
  unidadIntervaloConexion        String   @default("segundos")
  guardarAutomaticamente         Boolean  @default(true)
  
  // Preferencias de auditoría - Reportes automáticos
  auditRetentionDays             Int      @default(90)
  auditAutoPurgeEnabled          Boolean  @default(false)
  auditAutoPurgeFrequency        String   @default("weekly")
  auditAutoReportEnabled         Boolean  @default(false)
  auditAutoReportPeriod          String   @default("weekly")
  auditAutoReportHour            Int      @default(1)  // 0-23, default 1 AM
  auditAutoReportMinute          Int      @default(0)  // 0-59
  auditReportRetentionDays       Int      @default(90)  // Días para retener reportes generados
  notifyOnManualReport           Boolean  @default(true)  // Notificar al crear reporte manual
  notifyOnAutoReport             Boolean  @default(true)  // Notificar al crear reporte automático
  
  // Preferencias de backup automático
  autoBackupEnabled              Boolean  @default(false)
  autoBackupPeriod               String   @default("weekly")
  autoBackupHour                 Int      @default(2)  // 0-23, default 2 AM
  autoBackupMinute               Int      @default(0)  // 0-59
  autoBackupRetentionDays        Int      @default(30)

  @@index([userId])
}

model FinancialTemplate {
  id                   String   @id
  userId               String
  nombre               String
  desarrollo           Float    @default(0)
  descuento            Int      @default(0)
  opcionesPago         Json?
  tituloSeccionPago    String?  @default("Opciones de Pago")
  subtituloSeccionPago String?
  metodosPreferidos    Json?
  notasPago            String?
  configDescuentos     Json?
  descuentoPagoUnico   Int?     @default(0)
  createdAt            DateTime @default(now())
  updatedAt            DateTime

  @@index([userId])
}

// ==================== MODELO: Organización (Jerarquía) ====================
model Organization {
  id            String   @id @default(cuid())
  nombre        String
  sector        String
  descripcion   String?
  
  // Jerarquía
  parentId      String?
  parent        Organization? @relation("OrganizationHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children      Organization[] @relation("OrganizationHierarchy")
  nivel         String    @default("RAIZ")  // RAIZ, EMPRESA, DEPARTAMENTO, EQUIPO, PROYECTO
  
  // Contacto
  email         String?
  telefono      String?
  direccion     String?
  ciudad        String?
  pais          String?
  
  // Relaciones
  users         User[]
  quotations    QuotationConfig[]
  
  // Auditoría
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  createdBy     String
  updatedBy     String
  
  @@index([parentId])
  @@index([createdBy])
}

model Permission {
  id              String            @id @default(cuid())
  code            String            @unique
  name            String
  description     String?
  category        String
  isSystem        Boolean           @default(false)
  isActive        Boolean           @default(true)
  createdAt       DateTime          @default(now())
  RolePermissions RolePermissions[]
  UserPermission  UserPermission[]

  @@index([category])
  @@index([code])
  @@index([isActive])
}

// ==================== MODELO ROLE DINÁMICO ====================
model Role {
  id              String            @id @default(cuid())
  name            String            @unique
  displayName     String
  description     String?
  hierarchy       Int               @default(50)
  color           String?
  isSystem        Boolean           @default(false)
  isActive        Boolean           @default(true)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  users           User[]            @relation("UserRole")
  permissions     RolePermissions[]

  @@index([hierarchy])
  @@index([isActive])
}

// ==================== PERMISOS POR ROL (NUEVO - usa roleId) ====================
model RolePermissions {
  id            String     @id @default(cuid())
  roleId        String
  permissionId  String
  accessLevel   String     @default("full")

  role          Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission    Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
}

model Session {
  id           String   @id
  sessionToken String   @unique
  userId       String
  expires      DateTime
  User         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([sessionToken])
  @@index([userId])
}

model User {
  id                  String                @id @default(cuid())
  username            String                @unique
  email               String?               @unique
  passwordHash        String
  role                UserRole              @default(CLIENT)
  // Campo para migración gradual al modelo Role dinámico
  roleId              String?
  roleRef             Role?                 @relation("UserRole", fields: [roleId], references: [id])
  nombre              String                @default("")
  empresa             String                @default("")
  telefono            String                @default("")
  quotationAssignedId String?               @unique
  // NUEVO: Relación con Organization
  organizationId      String?
  organization        Organization?         @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  activo              Boolean               @default(true)
  lastLogin           DateTime?
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  createdBy           String?
  avatarUrl           String?
  Session             Session[]
  quotationAssigned   QuotationConfig?      @relation(fields: [quotationAssignedId], references: [id])
  UserPermission      UserPermission[]
  UserQuotationAccess UserQuotationAccess[]
  AuditLog            AuditLog[]
  
  // Relaciones de backup
  UserBackup          UserBackup[]
  BackupConfig        BackupConfig?
  
  // Relaciones de reportes
  AuditReports        AuditReport[]

  @@index([activo])
  @@index([email])
  @@index([quotationAssignedId])
  @@index([organizationId])
  @@index([role])
  @@index([roleId])
  @@index([username])
}

model UserPermission {
  id           String     @id
  userId       String
  permissionId String
  granted      Boolean
  Permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  User         User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, permissionId])
  @@index([permissionId])
  @@index([userId])
}

model UserQuotationAccess {
  id                String          @id
  userId            String
  quotationConfigId String
  canEdit           Boolean         @default(true)
  canDelete         Boolean         @default(false)
  assignedAt        DateTime        @default(now())
  assignedBy        String?
  isDefault         Boolean         @default(false)
  QuotationConfig   QuotationConfig @relation(fields: [quotationConfigId], references: [id], onDelete: Cascade)
  User              User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, quotationConfigId])
  @@index([quotationConfigId])
  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

enum UserRole {
  ADMIN
  CLIENT
  SUPER_ADMIN
}

// ==================== SISTEMA DE AUDITORÍA ====================
model AuditLog {
  id          String   @id @default(cuid())
  action      String
  entityType  String
  entityId    String?
  userId      String?
  userName    String
  details     Json?
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())

  user        User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([action])
  @@index([entityType])
  @@index([userId])
  @@index([createdAt])
}

// ==================== SISTEMA DE BACKUPS ====================
model UserBackup {
  id           String    @id @default(cuid())
  userId       String
  User         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  nombre       String
  descripcion  String?
  tipo         String    @default("manual")
  version      String?
  data         Json
  size         Int?
  estado       String    @default("completado")
  errorMessage String?
  createdAt    DateTime  @default(now())
  expiresAt    DateTime?

  @@index([userId])
  @@index([createdAt])
  @@index([tipo])
}

model BackupConfig {
  id                  String    @id @default(cuid())
  userId              String    @unique
  User                User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  autoBackupEnabled   Boolean   @default(false)
  autoBackupFrequency String    @default("weekly")
  autoBackupRetention Int       @default(5)
  notifyOnBackup      Boolean   @default(true)
  notifyOnRestore     Boolean   @default(true)
  lastAutoBackup      DateTime?
  nextAutoBackup      DateTime?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
}

// ==================== REPORTES DE AUDITORÍA ====================
model AuditReport {
  id                   String    @id @default(cuid())
  userId               String
  user                 User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  period               String    @default("weekly") // weekly, monthly, daily
  dateRangeFrom        DateTime
  dateRangeTo          DateTime
  
  // Resumen
  totalLogs            Int
  uniqueUsers          Int
  uniqueActions        Int
  uniqueEntities       Int
  
  // Datos completos del reporte (JSON para flexibilidad)
  reportData           Json      // Contiene topActions, entityDistribution, topUsers, dailyActivity
  
  // Auditoría del reporte
  generatedAt          DateTime  @default(now())
  generatedBy          String    @default("system") // "system" o userId
  filePath             String?   // Ruta si se guardó como archivo
  status               String    @default("completed") // completed, pending, failed
  errorMessage         String?
  
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  @@index([userId])
  @@index([period])
  @@index([generatedAt])
  @@index([createdAt])
}
