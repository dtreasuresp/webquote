// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DATABASE_URL_UNPOOLED")
}

model QuotationConfig {
  id                  String    @id @default(cuid())
  
  // Información de la Cotización
  numero              String    @unique @default("")
  versionNumber       Int       @default(1)
  fechaEmision        DateTime  @default(now())
  tiempoValidez       Int       @default(30)
  fechaVencimiento    DateTime
  presupuesto         String    @default("")
  moneda              String    @default("USD")
  
  // Información del Cliente
  empresa             String    @default("")
  sector              String    @default("")
  ubicacion           String    @default("")
  emailCliente        String    @default("")
  whatsappCliente     String    @default("")
  
  // Información del Proveedor
  profesional         String    @default("")
  empresaProveedor    String    @default("")
  emailProveedor      String    @default("")
  whatsappProveedor   String    @default("")
  ubicacionProveedor  String    @default("")
  
  // Tiempo de vigencia del contrato
  tiempoVigenciaValor Int       @default(12)
  tiempoVigenciaUnidad String   @default("meses")  // "días", "meses", "años"
  
  // Configuración del Hero (por cotización)
  heroTituloMain      String    @default("PROPUESTA DE COTIZACIÓN")
  heroTituloSub       String    @default("PÁGINA CATÁLOGO DINÁMICA")
  
  // Estados de control
  activo              Boolean   @default(true)
  isGlobal            Boolean   @default(false)
  
  // ==================== TEMPLATES REUTILIZABLES ====================
  // Servicios Base template (JSON Array)
  serviciosBaseTemplate       Json?
  // Servicios Opcionales template (JSON Array)
  serviciosOpcionalesTemplate Json?
  // Opciones de Pago template (JSON Array)
  opcionesPagoTemplate        Json?
  // Configuración de Descuentos template (JSON)
  configDescuentosTemplate    Json?
  // Descripciones de Paquete templates (JSON Array)
  descripcionesPaqueteTemplates Json?
  // Método de pago preferido a nivel de cotización
  metodoPagoPreferido         String?   @default("")
  // Notas de pago a nivel de cotización
  notasPago                   String?   @default("")
  // Configuración de estilos (JSON)
  estilosConfig               Json?
  
  // ==================== CONTENIDO GENERAL DINÁMICO ====================
  // Contenido editable: FAQ, Garantías, Contacto, Resumen, Términos
  contenidoGeneral            Json?
  
  // ==================== ESTADO DEL EDITOR ====================
  // Estado de secciones colapsadas/expandidas y otras preferencias del editor
  editorState                 Json?
  
  // Relaciones
  snapshots           PackageSnapshot[]
  
  // Control
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@index([createdAt])
  @@index([isGlobal])
  @@index([activo])
}

model PackageSnapshot {
  id                  String   @id @default(cuid())
  nombre              String
  
  // Servicios Base (JSON Array)
  serviciosBase       Json
  
  // Gestión
  gestionPrecio       Float
  gestionMesesGratis  Int
  gestionMesesPago    Int
  
  // Paquete
  desarrollo          Float
  descuento           Int
  tipo                String?
  descripcion         String?
  emoji               String?
  tagline             String?
  precioHosting       Float?
  precioMailbox       Float?
  precioDominio       Float?
  tiempoEntrega       String?
  opcionesPago        Json?     // Array de { nombre, porcentaje, descripcion }
  descuentoPagoUnico  Int?      // Porcentaje de descuento por pago único
  
  // ✅ NUEVO SISTEMA DE DESCUENTOS - ConfigDescuentos completo
  configDescuentos    Json?
  
  // Método de pago preferido para este paquete
  metodoPagoPreferido String?   @default("")
  // Notas de pago para este paquete
  notasPago           String?
  
  // @deprecated - Descuentos Generales (JSON) - mantener para compatibilidad
  descuentosGenerales Json?
  
  // @deprecated - Descuentos por Servicio (JSON) - mantener para compatibilidad  
  descuentosPorServicio Json?
  
  // Otros Servicios (JSON)
  otrosServicios      Json
  
  // Costos
  costoInicial        Float
  costoAño1           Float
  costoAño2           Float
  
  // Relación con QuotationConfig
  quotationConfigId   String?
  quotationConfig     QuotationConfig? @relation(fields: [quotationConfigId], references: [id], onDelete: Cascade)
  
  // Metadata
  activo              Boolean  @default(true)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@index([createdAt])
  @@index([quotationConfigId])
}

model UserPreferences {
  id                          String   @id @default(cuid())
  userId                      String   @unique
  
  // Preferencias del Modal
  cerrarModalAlGuardar        Boolean  @default(false)
  mostrarConfirmacionGuardado Boolean  @default(true)
  validarDatosAntes           Boolean  @default(true)
  
  // Preferencia para limpiar formularios al crear nueva cotización
  limpiarFormulariosAlCrear   Boolean  @default(true)
  
  // Control
  createdAt                   DateTime @default(now())
  updatedAt                   DateTime @updatedAt

  @@index([userId])
}
